name: SouthPlus签到

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'

jobs:
  run-script:
    runs-on: ubuntu-latest
    environment: main
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.x
    
    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Install Chrome
      run: |
        # 下载最新的稳定版 Chrome .deb 包
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        
        # 使用 apt 安装，它会自动处理依赖
        sudo apt-get update
        sudo apt-get install -y ./google-chrome-stable_current_amd64.deb
        
        # 清理下载的文件
        rm google-chrome-stable_current_amd64.deb
        
        # 验证安装
        echo "Chrome anstalled:"
        google-chrome-stable --version

    - name: Install ChromeDriver
      run: |
        # 安装必要的工具 (curl 用于 API 请求, jq 用于解析 JSON, unzip 用于解压)
        sudo apt-get update
        sudo apt-get install -y curl jq unzip

        # 1. 从官方 JSON API 获取最新的 "Stable" 频道版本号
        LATEST_STABLE_VERSION=$(curl -s https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions.json | jq -r '.channels.Stable.version')
        
        if [ -z "$LATEST_STABLE_VERSION" ]; then
          echo "Failed to fetch latest stable version"
          exit 1
        fi

        echo "Fetching latest stable ChromeDriver, version: $LATEST_STABLE_VERSION"

        # 2. 构建下载 URL 并下载
        wget "https://storage.googleapis.com/chrome-for-testing-public/${LATEST_STABLE_VERSION}/linux64/chromedriver-linux64.zip"

        # 3. 解压并移动到系统路径
        unzip chromedriver-linux64.zip
        sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
        
        # 4. 设置正确的权限
        sudo chown root:root /usr/local/bin/chromedriver
        sudo chmod +x /usr/local/bin/chromedriver

        # 5. 清理下载的文件
        rm chromedriver-linux64.zip
        rm -rf chromedriver-linux64

        # 6. 验证安装
        echo "ChromeDriver installed:"
        chromedriver --version

    - name: 总脚本
      env:
        COOKIE: ${{ secrets.COOKIE }}
        serverKey: ${{ secrets.serverKey }}
      run: python byWebdrvier.py
